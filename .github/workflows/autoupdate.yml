name: Update DNF Repository

on:
  push:
    branches: [ main ]
    #paths:
    #  - 'dnf-repo-test/Packages/**'

jobs:
  update:
    runs-on: ubuntu-latest
    container: fedora:latest
    defaults:
      run:
        working-directory: ./repo

    steps:
      - name: Install Git in container
        run: |
          dnf update -y
          dnf install -y git rpm createrepo  # Установка Git и зависимостей заранее[1]
          git config --global --add safe.directory "$GITHUB_WORKSPACE"  # Фикс для контейнера[1][5]

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0  # Полный fetch для истории

      - name: Reset and clean repository
        run: |
          git reset --hard HEAD  # Сброс изменений без конфликтов[3]
          git clean -fd  # Очистка untracked файлов (без -x, чтобы не трогать ignored)[2]

      - name: Check and fix RPM files
        run: |
          mkdir -p dnf-repo-test/Packages
          cd dnf-repo-test/Packages
          for pkg in *.rpm; do
            if ! rpm -K "$pkg"; then
              echo "Повреждённый пакет: $pkg — удаляем"
              rm "$pkg"
            fi
          done
          cd ../..

      - name: Update repository metadata
        run: createrepo --update --verbose dnf-repo-test

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add dnf-repo-test/
          git commit -m "Автоматическое обновление: исправлены пакеты" || echo "Нет изменений"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
